# -*- coding: utf-8 -*-

import os
import shutil

import apt
import apt.progress

SOURCE_LIST = '/etc/apt/sources.list'
SOURCE_LIST_BACKUP = '%s.brisa' % SOURCE_LIST
HUAYRA_REPO = 'http://repo.huayra.conectarigualdad.gob.ar/huayra'

def cambiar_repo():
    with open(SOURCE_LIST, 'r') as fd:
        renglones = fd.readlines()

    for index, data in enumerate(renglones):
        if 'brisa' in data and HUAYRA_REPO in data:
            renglones[index] = data.replace('brisa', 'pampero')

    with open(SOURCE_LIST, 'w') as fd:
        fd.write('\n'.join(renglones))


def es_brisa():
    with open(SOURCE_LIST, 'r') as fd:
        for renglon in fd:
            renglon = renglon.strip()

            if not renglon.startswith('#'):
                if 'brisa' in renglon:
                    return True

    return False

def actualizar_huayra():
    if not es_brisa():
        print('Ya estás usando la última versión disponible de Huayra!')

    else:
        if not os.path.isfile(SOURCE_LIST_BACKUP):
            shutil.copy2(SOURCE_LIST, SOURCE_LIST_BACKUP)

        actualizar_distro()
        print 'Brisa Update'

        cambiar_repo()
        print('cambia repo')

        actualizar_distro()
        print('listo')


def actualizar_distro():
    cache = apt.Cache()
    cache.update(apt.progress.text.AcquireProgress())
    cache.open(None)

    cache.upgrade()
    cache.upgrade(True)

    cache.commit(apt.progress.text.AcquireProgress(),
                 apt.progress.base.InstallProgress())


if __name__ == '__main__':
    print('+----')
    print('| Bienvenido al actualizador de Huayra!')
    print('+----\n')

    if not os.access(SOURCE_LIST, os.W_OK):
        print(' El actualizador debe ser ejecutado como root.')
        print(' Ej.: $ sudo huayra-update\n')

    else:
        actualizar_huayra()
